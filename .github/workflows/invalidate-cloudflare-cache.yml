name: Invalidate Cloudflare Cache (Reusable)

on:
  workflow_call:
    inputs:
      cloudflare_zone_id:
        description: "Cloudflare Zone ID"
        required: true
        type: string
      purge_everything:
        description: "Purge all cached content (if false, uses purge_urls or purge_prefixes)"
        required: false
        type: boolean
        default: true
      purge_urls:
        description: "JSON array of specific URLs to purge (e.g., '[\"https://example.com/main/\"]')"
        required: false
        type: string
        default: ""
      purge_prefixes:
        description: "JSON array of URL prefixes to purge (Enterprise only, e.g., '[\"https://example.com/main/\"]')"
        required: false
        type: string
        default: ""
      purge_hosts:
        description: "JSON array of hostnames to purge (e.g., '[\"example.com\"]')"
        required: false
        type: string
        default: ""
      purge_tags:
        description: "JSON array of cache tags to purge (Enterprise only)"
        required: false
        type: string
        default: ""
    secrets:
      cloudflare_api_token:
        description: "Cloudflare API token with cache purge permissions"
        required: true
    outputs:
      purge_id:
        description: "The ID of the purge request"
        value: ${{ jobs.invalidate.outputs.purge_id }}
      purge_type:
        description: "Type of purge performed (everything, urls, prefixes, hosts, tags)"
        value: ${{ jobs.invalidate.outputs.purge_type }}

jobs:
  invalidate:
    name: Invalidate Cloudflare Cache
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      purge_id: ${{ steps.purge.outputs.id }}
      purge_type: ${{ steps.purge.outputs.type }}

    steps:
    - name: Purge Cloudflare cache
      id: purge
      env:
        CF_ZONE_ID: ${{ inputs.cloudflare_zone_id }}
        CF_API_TOKEN: ${{ secrets.cloudflare_api_token }}
      run: |
        API_URL="https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/purge_cache"
        
        # Determine purge type and build request body
        if [ "${{ inputs.purge_everything }}" = "true" ]; then
          echo "Purging all cached content..."
          BODY='{"purge_everything": true}'
          PURGE_TYPE="everything"
        elif [ -n "${{ inputs.purge_urls }}" ]; then
          echo "Purging specific URLs..."
          BODY='{"files": ${{ inputs.purge_urls }}}'
          PURGE_TYPE="urls"
        elif [ -n "${{ inputs.purge_prefixes }}" ]; then
          echo "Purging by prefixes (Enterprise only)..."
          BODY='{"prefixes": ${{ inputs.purge_prefixes }}}'
          PURGE_TYPE="prefixes"
        elif [ -n "${{ inputs.purge_hosts }}" ]; then
          echo "Purging by hostnames..."
          BODY='{"hosts": ${{ inputs.purge_hosts }}}'
          PURGE_TYPE="hosts"
        elif [ -n "${{ inputs.purge_tags }}" ]; then
          echo "Purging by cache tags (Enterprise only)..."
          BODY='{"tags": ${{ inputs.purge_tags }}}'
          PURGE_TYPE="tags"
        else
          echo "âŒ Error: No purge method specified"
          echo "Set purge_everything=true or provide purge_urls, purge_prefixes, purge_hosts, or purge_tags"
          exit 1
        fi
        
        echo "type=${PURGE_TYPE}" >> $GITHUB_OUTPUT
        
        # Make API request
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${API_URL}" \
          -H "Authorization: Bearer ${CF_API_TOKEN}" \
          -H "Content-Type: application/json" \
          -d "${BODY}")
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
        
        # Check response
        if [ "$HTTP_CODE" -eq 200 ]; then
          SUCCESS=$(echo "$RESPONSE_BODY" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            PURGE_ID=$(echo "$RESPONSE_BODY" | jq -r '.result.id // "N/A"')
            echo "âœ… Cloudflare cache purge successful!"
            echo "Purge ID: ${PURGE_ID}"
            echo "id=${PURGE_ID}" >> $GITHUB_OUTPUT
          else
            ERRORS=$(echo "$RESPONSE_BODY" | jq -r '.errors[]?.message // "Unknown error"')
            echo "âŒ Cloudflare API returned success=false"
            echo "Errors: ${ERRORS}"
            exit 1
          fi
        else
          echo "âŒ Cloudflare API request failed with HTTP ${HTTP_CODE}"
          echo "Response: ${RESPONSE_BODY}"
          exit 1
        fi

    - name: Cache Invalidation Summary
      run: |
        echo "## ðŸŒ Cloudflare Cache Invalidation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Zone ID**: \`${{ inputs.cloudflare_zone_id }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Purge Type**: ${{ steps.purge.outputs.type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Purge ID**: \`${{ steps.purge.outputs.id }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY

